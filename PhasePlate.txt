ScriptName PhasePlate
# script to skip bad Phase Plate Patch
#
# It uses a fucntion to see if a numher is among a list 
#### AlongList? 1 0 nP ####
# Yes assign 1 to RepVal1 or No assign 0 to RepVal1

##### User Input #####
# how many shot before Next Patch
#shot  = 16

# bad list patches and current one shown on TUI
## Ph1
list = {  1 26 40 43 45 59 60 61 62 63 64 65 66 67 68 69  }
##Ph2
#list = { 28 42 58 59 60 61 62 63 }
current = 32

##### no editing below #####

# counter for patch number
IsVariableDefined nP
If $repVal1 == 0 
   nP := $current
Endif
echo nP = $nP

## make sure this one is good to start with
#CallFunction 19::NextGood

# counter for Acquire point starts after new patch
IsVariableDefined nA
echo RepVal1 = $RepVal1
If $repVal1 == 0 
   nA := 1
Endif

echo nA = $nA

# main script to take shot 
Call LD
echo !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  Main !!!!!!!!!!!!!!!!!!!!!!!!


# after certain shots done, switch to next good and reset counter
If $nA > 40
  echo SHOULD SWITCH
   ShowMessageOnScope SerialEM PP
   CallFunction NextGood   
   nA := 
   np := $nP + 1
Else
   nA := $nA + 1
Endif


########################################
Function NextGood
# now switch to next Good one
Loop 76
#echo IN LOOP
#echo nP = $nP
CallFunction MyFuncs::AmongList? $nP
#echo RepVal1 = $RepVal1
If $RepVal1 == 1
   Echo Bad one, skipping ...
   ShowMessageOnScope SerialEM PP
    If $nP > 76
        nP := 1
    Else
        nP := $nP + 1
    Endif
Else 
   CallFunction Charger
   Echo This is GOOD patch, take shots ...
   break
Endif
Endloop
EndFunction 

#####################################
Function Charger 
## using R to charge PP in LD mode for 59 seconds

# original 
ReportUserSetting  LowDoseAreaToShow Area
SetUserSetting LowDoseAreaToShow 3
ScreenDown 
Delay 59
ScreenUp

# resume orignal 
SetUserSetting LowDoseAreaToShow $Area
EndFunction 

######################################
Function AmongList? 1 0 nP
# a function to see if a integer number is among a list "list"
# list must be defined somewhere in the main script

Loop $#list ind
if $n == $list[$ind]
 last = $ind
  break
else
   last = $ind
Endif
EndLoop

If $last <  $#list  OR $n ==  $list[$#list] 
   #echo Among
   RepVal1 = 1
Else
  # echo Not among
   RepVal1 = 0
Endif

EndFunction
