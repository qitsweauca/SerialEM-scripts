;; AutoIT script to wait for SerialEM Message Windows popping up.
;; Based on the message text content, it runs different functions,
;; to get shutter state and aperture conbination ready.
;; SerialEM script two lines for each action is below
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;SetupScopeMessage 0 0 K2-shutter
;ShowMessageOnScope SEM

;SetupScopeMessage 0 0 C2_150-OBJ_out
;ShowMessageOnScope SEM

;SetupScopeMessage 0 0 C2_70-OBJ_70
;ShowMessageOnScope SEM

;SetupScopeMessage 0 0 C2_50-OBJ_70
;ShowMessageOnScope SEM

;SetupScopeMessage 0 0 C2_50-OBJ_100
;ShowMessageOnScope SEM

;SetupScopeMessage 0 0 Turbo_ON
;ShowMessageOnScope SEM

;SetupScopeMessage 0 0 Turbo_OFF
;ShowMessageOnScope SEM

; etc...

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; -Chen Xu <chen.xu@umassmed.edu> Jan-29-2017
;; updated @ April 18, 2019
#include <MsgBoxConstants.au3>

; Set the Escape hotkey to terminate the script.
HotKeySet("{ESC}", "Terminate");

; make sure the "Camera" tab is at fromt
;MouseClick("primary",210,36,10)		;make sure to very left
;MouseClick("primary",227,40,2)		;come back twice, so "camera" is there
;MouseClick("primary",118,41,1)		;click on the camera

; C2 = 150, 70, 50, 30
; Obj = 70, 100, Ph P1, Ph P2, Ph P3, Ph P4, Ph p5, Ph P6

Main()

Func Main()

	While 1
	WinWait("[TITLE:SEM; CLASS:#32770]")
If WinExists("[TITLE:SEM; CLASS:#32770]") Then
	WinActivate ("[TITLE:SEM; CLASS:#32770]")
	Local $sText = WinGetText("[ACTIVE]")
EndIf

If StringInStr($sText,"C2_150-OBJ_out") Then
	Call ("C2_150_OBJ_out")
	Sleep(5000)
Elseif StringInStr($sText,"C2_70-OBJ_100") Then
	Call ("C2_70_OBJ_100")
	Sleep(5000)
Elseif StringInStr($sText,"C2_50-OBJ_100") Then
	Call ("C2_50_OBJ_100")
	Sleep(5000)
Elseif StringInStr($sText,"C2_30-OBJ_100") Then
	Call ("C2_30_OBJ_100")
	Sleep(5000)
Elseif StringInStr($sText,"C2_70-OBJ_70") Then
	Call ("C2_70_OBJ_70")
	Sleep(5000)
Elseif StringInStr($sText,"C2_50-OBJ_70") Then
	Call ("C2_50_OBJ_70")
	Sleep(5000)
Elseif StringInStr($sText,"C2_30-OBJ_70") Then
	Call ("C2_30_OBJ_70")
	Sleep(5000)
ElseIf StringInStr($sText,"K2-shutter") Then
	Call ("K2_shutter")
	Sleep (5000)
ElseIf StringInStr($sText,"Turbo_ON") Then
	Call ("Turbo_ON")
	Sleep (5000)
ElseIf StringInStr($sText,"Turbo_OFF") Then
	Call ("Turbo_OFF")
	Sleep (5000)
EndIf

	 Sleep (500)
	 WEnd
EndFunc


;;;;;;;;;;;;;;;;;;;   model ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func C2_70_OBJ_100()

; select C2
WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "ShowDropDown", "")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "SelectString", "70")
ControlSend ("Apertures", "","ComboBox1", "{ENTER}")
Sleep (6000)

; set obj -> two colors are tested!!!
; already in yellow, but wrong size
If pixelgetcolor(25,381) = 0xFFFF80 Then
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "100")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf
If pixelgetcolor(25,381) = 0xD4D0C8 Then
	;Sleep (1000)
	;MsgBox(0, "Not Yellow, Click!", "","")
	WinActivate ("Apertures", "[CLASS:#32770]")
	ControlClick("Apertures", "", "[CLASS:Button; INSTANCE:2]")
	sleep (11000)
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "100")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf

Call ("Dismiss")
EndFunc


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func C2_50_OBJ_100()
; select C2
WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "ShowDropDown", "")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "SelectString", "50")
ControlSend ("Apertures", "","ComboBox1", "{ENTER}")
Sleep (6000)

; set obj -> two colors are tested!!!
; already in yellow, but wrong size
If pixelgetcolor(25,381) = 0xFFFF80 Then
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "100")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf
If pixelgetcolor(25,381) = 0xD4D0C8 Then
	;Sleep (1000)
	;MsgBox(0, "Not Yellow, Click!", "","")
	WinActivate ("Apertures", "[CLASS:#32770]")
	ControlClick("Apertures", "", "[CLASS:Button; INSTANCE:2]")
	sleep (11000)
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "100")
    ControlSend ("Apertures", "","ComboBox2 ", "{ENTER}")
    Sleep (6000)
EndIf

Call ("Dismiss")
EndFunc

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func C2_30_OBJ_100()
; select C2
WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "ShowDropDown", "")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "SelectString", "30")
ControlSend ("Apertures", "","ComboBox1", "{ENTER}")
Sleep (6000)

; set obj -> two colors are tested!!!
; already in yellow, but wrong size
If pixelgetcolor(25,381) = 0xFFFF80 Then
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "100")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf
If pixelgetcolor(25,381) = 0xD4D0C8 Then
	;Sleep (1000)
	;MsgBox(0, "Not Yellow, Click!", "","")
	WinActivate ("Apertures", "[CLASS:#32770]")
	ControlClick("Apertures", "", "[CLASS:Button; INSTANCE:2]")
	sleep (11000)
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "100")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf

Call ("Dismiss")
EndFunc

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func C2_70_OBJ_70()
; select C2
WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "ShowDropDown", "")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "SelectString", "70")
ControlSend ("Apertures", "","ComboBox1", "{ENTER}")
Sleep (6000)

; set obj -> two colors are tested!!!
; already in yellow, but wrong size
If pixelgetcolor(25,381) = 0xFFFF80 Then
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "70")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf
If pixelgetcolor(25,381) = 0xD4D0C8 Then
	;Sleep (1000)
	;MsgBox(0, "Not Yellow, Click!", "","")
	WinActivate ("Apertures", "[CLASS:#32770]")
	ControlClick("Apertures", "", "[CLASS:Button; INSTANCE:2]")
	sleep (11000)
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "70")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf

Call ("Dismiss")
EndFunc

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func C2_50_OBJ_70()
; select C2
WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "ShowDropDown", "")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "SelectString", "50")
ControlSend ("Apertures", "","ComboBox1", "{ENTER}")
Sleep (6000)

; set obj -> two colors are tested!!!
; already in yellow, but wrong size
If pixelgetcolor(25,381) = 0xFFFF80 Then
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "70")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf
If pixelgetcolor(25,381) = 0xD4D0C8 Then
	;Sleep (1000)
	;MsgBox(0, "Not Yellow, Click!", "","")
	WinActivate ("Apertures", "[CLASS:#32770]")
	ControlClick("Apertures", "", "[CLASS:Button; INSTANCE:2]")
	sleep (11000)
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "70")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf

Call ("Dismiss")
EndFunc

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func C2_30_OBJ_70()
; select C2
WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "ShowDropDown", "")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "SelectString", "30")
ControlSend ("Apertures", "","ComboBox1", "{ENTER}")
Sleep (6000)

; set obj -> two colors are tested!!!
; already in yellow, but wrong size
If pixelgetcolor(25,381) = 0xFFFF80 Then
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "70")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf
If pixelgetcolor(25,381) = 0xD4D0C8 Then
	;Sleep (1000)
	;MsgBox(0, "Not Yellow, Click!", "","")
	WinActivate ("Apertures", "[CLASS:#32770]")
	ControlClick("Apertures", "", "[CLASS:Button; INSTANCE:2]")
	sleep (11000)
    WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "ShowDropDown", "")
    ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:2]", "SelectString", "70")
    ControlSend ("Apertures", "","ComboBox2", "{ENTER}")
    Sleep (6000)
EndIf

Call ("Dismiss")
EndFunc

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func C2_150_OBJ_out()

; select C2, OBJ aperture
WinActivate ("[TITLE:Apertures; CLASS:#32770; W:243; H:225]")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "ShowDropDown", "")
ControlCommand ("Apertures", "", "[CLASS:ComboBox; INSTANCE:1]", "SelectString", "150")
ControlSend ("Apertures", "","ComboBox1", "{ENTER}")
Sleep (6000)
;
; make sure "Objective" is NOT Yellow
If pixelgetcolor(51,381) = 0xFFFF80 Then
	;Sleep (1000)
	WinActivate ("Apertures", "[CLASS:#32770]")
	ControlClick("Apertures", "", "[CLASS:Button; INSTANCE:2]")
Else
	Sleep (1000)
EndIf

Call ("Dismiss")
EndFunc

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func K2_shutter()
; select fake K2 camera
ControlCommand("CCD/TV Camera", "", "[CLASS:ComboBox; INSTANCE:1]", "SelectString", "BM-Falcon")
Sleep(3000)		; needed

; make sure the Insert is "yellow"
If pixelgetcolor(48,270) = 0xD4D0C8 Then
	;Sleep (1000)
	;MsgBox(0, "Not Yellow, Click!", "","")
	WinActivate ("CCD/TV Camera", "[CLASS:#32770]")
	ControlClick("CCD/TV Camera", "", "[CLASS:Button; INSTANCE:4]")
	ControlClick("CCD/TV Camera", "", "[CLASS:Button; INSTANCE:4]")
	Sleep (3000)	;needed
Else
	Sleep (4000)
EndIf

Call ("Dismiss")

EndFunc



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func Turbo_ON()
 WinWait("[TITLE:SEM; CLASS:#32770]")
 If WinExists("[TITLE:SEM; CLASS:#32770]") Then
	 WinActivate ("Autoloader (User)", "[CLASS:#32770]")
ControlClick("Autoloader (User)", "", "[CLASS:Button; INSTANCE:12]")
ControlClick("SEM", "", "[CLASS:Button; INSTANCE:1]")
 EndIf
 EndFunc

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func Turbo_OFF()
 WinWait("[TITLE:SEM; CLASS:#32770]")
 If WinExists("[TITLE:SEM; CLASS:#32770]") Then
	 WinActivate ("Autoloader (User)", "[CLASS:#32770]")
ControlClick("Autoloader (User)", "", "[CLASS:Button; INSTANCE:11]")
ControlClick("SEM", "", "[CLASS:Button; INSTANCE:1]")
 EndIf
 EndFunc


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func Dismiss()
	; dismiss SerialEM message window
WinActivate ("[TITLE:SEM; CLASS:#32770]")
ControlClick("SEM", "", "[CLASS:Button; INSTANCE:1]")
EndFunc

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
Func Terminate()
    Exit
EndFunc   ;==>Terminate

