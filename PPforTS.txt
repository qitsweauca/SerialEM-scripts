ScriptName PPforTS
## Phase Plate Control for Tilting Series
## chen.xu@umassmed.edu - Sept 28, 2017

# User inputs:
# 1) switch after how many tilting series (nA), edit below 
# 2) assuming always charge new patch in a broken mesh, X,Y position of it

X_broken = 
Y_broken =

# It uses a fucntion to see if a numher is among a list 
#### AlongList? 1 0 nP ####
# Yes assign 1 to RepVal1 or No assign 0 to RepVal1

##### User Input #####
# how many shot before Next Patch
#shot  = 16

# bad list patches and current one shown on TUI
## Ph1
list = {  1 26 40 43 45 59 60 61 62 63 64 65 66 67 68 69  }
##Ph2
#list = { 28 42 58 59 60 61 62 63 }
current = 32

##### no editing below #####

# counter for patch number
IsVariableDefined nP
If $repVal1 == 0 
   nP := $current
Endif
echo nP = $nP

## make sure this one is good to start with
#CallFunction 19::NextGood

# counter for Acquire point starts after new patch
IsVariableDefined nA
echo RepVal1 = $RepVal1
If $repVal1 == 0 
   nA := 1
Endif

echo nA = $nA

# main script to take shot 
#Call LD
echo !!!! Doing Titlting Series... !!!!


# after certain shots done, switch to next good and reset counter
If $nA > 3
   echo SHOULD SWITCH
   MoveStageTo $X $Y
   ShowMessageOnScope SerialEM PP
   CallFunction NextGood   
   nA := 
   np := $nP + 1
Else
   nA := $nA + 1
Endif


########################################
Function NextGood
# now switch to next Good one
Loop 76
#echo IN LOOP
#echo nP = $nP
CallFunction AmongList? $nP
#echo RepVal1 = $RepVal1
If $RepVal1 == 1
   Echo Bad one, skipping ...
   ShowMessageOnScope SerialEM PP
    If $nP > 76
        nP := 1
    Else
        nP := $nP + 1
    Endif
Else 
   Echo This is GOOD patch, charging ...
   CallFunction Charger
   break
Endif
Endloop
EndFunction 

#####################################
Function Charger 
## using R to charge PP in LD mode for 10 minutes after switching 5 minutes 
## you need to test it if this works on your version of SerialEM

# original 
ReportUserSetting  LowDoseAreaToShow Area
SetUserSetting LowDoseAreaToShow 3
# stablize it first for 5 min
Delay 5 min
# now lower screen to charge it
ScreenDown 
Delay 10 min
ScreenUp

# resume orignal 
SetUserSetting LowDoseAreaToShow $Area
EndFunction 

######################################
Function AmongList? 1 0 nP
# a function to see if a integer number is among a list "list"
# list must be defined somewhere in the main script

Loop $#list ind
if $n == $list[$ind]
 last = $ind
  break
else
   last = $ind
Endif
EndLoop

If $last <  $#list  OR $n ==  $list[$#list] 
   #echo Among
   RepVal1 = 1
Else
  # echo Not among
   RepVal1 = 0
Endif

EndFunction
